---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Navbar from '../../components/Navbar.astro';
import Footer from '../../components/Footer.astro';
import { BLOG_POSTS, AUTHORS } from '../../constants';

export async function getStaticPaths() {
  return BLOG_POSTS.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;

// Find complete author data
const authorData = AUTHORS.find(a => a.name === post.author) || {
    name: post.author,
    role: post.authorRole,
    authorImage: post.authorImage,
    bio: "Experto en nutrición y rendimiento deportivo.",
    slug: "maestro"
};

// Filter related posts (exclude current and future posts)
const relatedPosts = BLOG_POSTS.filter(p => {
    const postDate = new Date(p.date.split('-').reverse().join('-'));
    const now = new Date('2026-02-16');
    return p.id !== post.id && postDate <= now;
}).slice(0, 3);

// Generate TOC from H2 and H3 tags
const toc = [];
const h2Matches = post.content.matchAll(/<h2[^>]*>(.*?)<\/h2>/gi);
for (const match of h2Matches) {
    const title = match[1].replace(/<[^>]*>/g, '');
    const id = title.toLowerCase().replace(/[^\w\s-]/g, '').replace(/\s+/g, '-');
    toc.push({ id, title, level: 2 });
}

// Format tags
const formatTag = (tag) => {
    return tag.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
};

---

<BaseLayout title={`${post.title} | Chikara Nutrition`} description={post.excerpt}>
  <Navbar currentPath="/blog/" forceTransparent={true} />
  
  <main class="bg-chikara-paper min-h-screen">
      <!-- Mega Hero Section -->
      <section class="relative h-[70vh] min-h-[500px] flex items-end overflow-hidden">
          <!-- Background Image with dynamic grayscale/color transition on load -->
          <div class="absolute inset-0 z-0">
              <img src={post.image} alt={post.title} class="w-full h-full object-cover grayscale brightness-50" />
              <div class="absolute inset-0 bg-gradient-to-t from-chikara-ink via-chikara-ink/40 to-transparent"></div>
          </div>

          <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative z-10 pb-16 w-full">
              <div class="max-w-4xl">
                  <h1 class="text-5xl md:text-8xl font-display font-bold text-white uppercase leading-[0.9] mb-8 tracking-tighter drop-shadow-2xl">
                      {post.title}
                  </h1>
              </div>
          </div>

          <!-- Vertical Text Decoration -->
          <div class="absolute right-8 top-1/2 -translate-y-1/2 hidden lg:block text-vertical text-white/5 font-jp font-black text-9xl pointer-events-none select-none">
              {post.id === 1 ? '無心' : post.id === 2 ? '健康' : '不動心'}
          </div>
      </section>

      <!-- Content Area -->
      <article class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 -mt-10 relative z-20">
        <div class="flex flex-col lg:flex-row gap-16">
            <!-- Main Content -->
            <div class="w-full lg:w-2/3 bg-white p-8 md:p-16 shadow-2xl border-t-8 border-chikara-red">
                
                <!-- Table of Contents -->
                {toc.length > 0 && (
                    <div class="mb-12">
                        <details class="group bg-stone-50 border border-gray-100 p-6 transition-all duration-300">
                            <summary class="flex items-center justify-between font-display font-bold uppercase tracking-widest text-sm cursor-pointer list-none">
                                <span class="flex items-center gap-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-chikara-red"><line x1="21" x2="3" y1="6" y2="6"/><line x1="21" x2="9" y1="12" y2="12"/><line x1="21" x2="7" y1="18" y2="18"/></svg>
                                    Índice de Sabiduría
                                </span>
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="transition-transform group-open:rotate-180"><path d="m6 9 6 6 6-6"/></svg>
                            </summary>
                            <nav class="mt-6">
                                <ul class="space-y-3">
                                    {toc.map(item => (
                                        <li>
                                            <a href={`#${item.id}`} class="text-gray-600 hover:text-chikara-red transition-colors text-sm font-serif italic border-l-2 border-transparent hover:border-chikara-red pl-4 py-1 block">
                                                {item.title}
                                            </a>
                                        </li>
                                    ))}
                                </ul>
                            </nav>
                        </details>
                    </div>
                )}

                <div class="chikara-blog-content" set:html={post.content.replace(/<h2[^>]*>(.*?)<\/h2>/gi, (match, title) => {
                    const id = title.replace(/<[^>]*>/g, '').toLowerCase().replace(/[^\w\s-]/g, '').replace(/\s+/g, '-');
                    return `<h2 id="${id}">${title}</h2>`;
                })} />
                
                <!-- Tags at bottom -->
                <div class="mt-16 pt-8 border-t border-gray-100">
                    <div class="flex flex-wrap gap-3">
                        <span class="text-xs font-bold uppercase tracking-widest text-gray-400 w-full mb-2">Marcas de Honor:</span>
                        {post.tags.map(tag => (
                            <span class="bg-stone-100 text-chikara-ink text-[10px] uppercase font-bold px-4 py-2 tracking-widest hover:bg-chikara-red hover:text-white transition-colors cursor-default">
                                {formatTag(tag)}
                            </span>
                        ))}
                    </div>
                </div>
                
                <!-- Post Footer / Actions -->
                <div class="mt-20 pt-12 border-t border-gray-100 flex flex-wrap items-center justify-between gap-8">
                    <div class="flex items-center gap-6">
                        <span class="text-xs font-bold uppercase tracking-widest text-gray-400">Compartir el Camino:</span>
                        <div class="flex gap-6">
                             <a href="#" class="text-chikara-ink hover:text-chikara-red transition-all transform hover:-translate-y-1">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 4s-.7 2.1-2 3.4c1.6 10-9.4 17.3-18 11.6 2.2.1 4.4-.6 6-2C3 15.5.5 9.6 3 5c2.2 2.6 5.6 4.1 9 4-.9-4.2 4-6.6 7-3.8 1.1 0 3-1.2 3-1.2z"></path></svg>
                             </a>
                             <a href="#" class="text-chikara-ink hover:text-chikara-red transition-all transform hover:-translate-y-1">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path></svg>
                             </a>
                        </div>
                    </div>
                    <a href="/blog/" class="group flex items-center gap-3 bg-chikara-ink text-white px-10 py-5 font-display font-bold uppercase tracking-[0.2em] hover:bg-chikara-red transition-all shadow-xl">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="transition-transform group-hover:-translate-x-1"><path d="m15 18-6-6 6-6"></path></svg>
                        Volver al Blog
                    </a>
                </div>
            </div>

            <!-- Sidebar -->
            <aside class="w-full lg:w-1/3">
                <div class="sticky top-24 space-y-10">
                    <div class="bg-chikara-ink text-white p-10 relative overflow-hidden">
                        <div class="absolute -right-6 -bottom-6 text-9xl text-white/5 font-jp font-black select-none">師</div>
                        
                        <img src={authorData.authorImage} alt={authorData.name} class="w-32 h-32 object-cover grayscale border-4 border-chikara-red mb-8 mx-auto shadow-2xl" />
                        <h4 class="font-display font-bold text-3xl uppercase mb-1">{authorData.name}</h4>
                        <p class="text-chikara-red font-bold uppercase text-xs tracking-widest mb-6">{authorData.role}</p>
                        <p class="text-gray-400 text-sm font-light leading-relaxed mb-8 italic line-clamp-4">
                            "{authorData.bio}"
                        </p>
                        <a href={`/autor/${authorData.slug}/`} class="inline-flex items-center gap-2 bg-white text-chikara-ink px-6 py-3 font-display font-bold uppercase text-xs tracking-widest hover:bg-chikara-red hover:text-white transition-all">
                            Ver Perfil Maestro
                        </a>
                    </div>

                    <!-- Related Posts -->
                    <div class="bg-white border border-gray-200 p-8 shadow-sm">
                        <h3 class="font-display font-bold text-xl uppercase text-chikara-ink mb-8 border-l-4 border-chikara-red pl-4">Siguiente Pergamino</h3>
                        <div class="space-y-8">
                            {relatedPosts.map(p => (
                                <a href={`/blog/${p.slug}/`} class="group block border-b border-gray-100 pb-8 last:border-0 last:pb-0">
                                    <div class="flex gap-4 mb-4 overflow-hidden">
                                        <div class="w-20 h-20 flex-shrink-0 bg-stone-100 overflow-hidden">
                                            <img src={p.image} alt={p.title} class="w-full h-full object-cover grayscale group-hover:grayscale-0 transition-all duration-500" />
                                        </div>
                                        <div class="flex flex-col justify-center">
                                            <span class="text-chikara-red text-[10px] uppercase font-bold tracking-widest mb-1">{p.date}</span>
                                            <h4 class="font-display font-bold text-sm text-chikara-ink uppercase group-hover:text-chikara-red transition-colors line-clamp-2 leading-tight">{p.title}</h4>
                                        </div>
                                    </div>
                                </a>
                            ))}
                        </div>
                    </div>
                </div>
            </aside>
        </div>
      </article>
      
      </article>
    </main>

  <Footer />
</BaseLayout>

<style is:global>
  @reference "../../styles/global.css";

  .chikara-blog-content {
    @apply font-serif text-gray-800 leading-relaxed text-xl;
  }
  .chikara-blog-content h2 {
    @apply font-display font-bold uppercase text-chikara-ink text-4xl mt-16 mb-8 pb-4 border-b-2 border-gray-100 relative tracking-tight;
  }
  .chikara-blog-content h2::before {
    content: '';
    @apply absolute bottom-[-2px] left-0 w-16 h-[2.5px] bg-chikara-red;
  }
  .chikara-blog-content h3 {
    @apply font-display font-bold uppercase text-chikara-ink text-2xl mt-12 mb-6 tracking-tight;
  }
  .chikara-blog-content h4 {
    @apply font-display font-bold uppercase text-chikara-ink text-xl mt-10 mb-4 tracking-tight;
  }
  .chikara-blog-content h5 {
    @apply font-display font-bold uppercase text-chikara-ink text-lg mt-8 mb-4 tracking-tight;
  }
  .chikara-blog-content a {
    @apply text-chikara-red hover:text-chikara-ink transition-colors underline underline-offset-4 decoration-chikara-red/30 hover:decoration-chikara-ink;
  }
  .chikara-blog-content p {
    @apply mb-8 text-xl font-light leading-relaxed;
  }
  .chikara-blog-content strong {
    @apply text-chikara-ink font-bold;
  }
  .chikara-blog-content ul {
    @apply list-none pl-0 mb-10;
  }
  .chikara-blog-content li {
    @apply relative pl-8 mb-4 font-light;
  }
  .chikara-blog-content li::before {
    content: '';
    @apply absolute left-0 top-[0.65em] w-4 h-[2px] bg-chikara-red;
  }
  .chikara-blog-content blockquote {
    @apply italic my-16 relative text-center border-l-0 pl-0;
  }
  .chikara-blog-content blockquote::before {
    content: '“';
    @apply text-chikara-red/20 text-9xl font-serif absolute top-[-40px] left-1/2 -translate-x-1/2;
  }
  .chikara-blog-content blockquote p {
    @apply text-3xl text-chikara-ink font-display uppercase leading-none mb-0;
  }

  /* Specific style for Intro (Summary) */
  .chikara-blog-content blockquote.intro {
    @apply not-italic my-8 relative text-left border-l-0 p-0 text-gray-500 font-serif italic text-base leading-relaxed;
  }
  .chikara-blog-content blockquote.intro::before {
    display: none;
  }
  .chikara-blog-content blockquote.intro p {
    @apply text-base font-serif italic normal-case leading-relaxed text-gray-500 mb-0;
  }

  /* Specific style for Cita (Final Quote) */
  .chikara-blog-content blockquote.cita {
    @apply italic my-24 relative text-center border-l-0 pl-0 py-12;
  }
  .chikara-blog-content blockquote.cita::before {
    content: '“';
    @apply text-chikara-red/20 text-9xl font-serif absolute top-[-40px] left-1/2 -translate-x-1/2;
  }
  .chikara-blog-content blockquote.cita p {
    @apply text-3xl text-chikara-ink font-display uppercase leading-tight mb-0 max-w-2xl mx-auto;
  }

  .text-vertical {
    writing-mode: vertical-rl;
    text-orientation: mixed;
  }
</style>
